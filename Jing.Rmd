---
title: "new_data"
author: "LYU JING"
date: "9/22/2022"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1. Clean 

2. DATA DISCRIPTION: 1.FEATURE CLASSIFICATIOn; 2.age/gender 3.housing insecure

```{r}
library(tidyverse)
library(readxl)
library(recipes)
library(caret)


training = read_csv("data/training_new.csv") 

  
```

```{r}
data_num <- training[ ,unlist(lapply(training, is.numeric))]

#names(data_num)


```


```{r}


column_limit_na = names(which(colSums(is.na(data_num))<10000))

```

```{r}
#skimr::skim(data_num)
```


```{r}
data_have_limit_na = data_num[,column_limit_na]

data_num2 = data_have_limit_na %>% 
  select(hi_flag,-id,everything())

#%>%drop_na()
```


```{r}

rec1 = recipe(hi_flag ~ ., data = data_num2) %>%
  step_impute_knn(all_predictors()) %>% 
  step_center(all_predictors()) %>%
  step_scale(all_predictors()) %>% 
  step_nzv(all_predictors()) 
#%>%
#  step_pca(all_predictors(), threshold = .95) 

prep(rec1, training = data_num2, retain = TRUE) %>% 
  juice(all_predictors()) %>% 
  ncol()

select_features = prep(rec1, training = data_num2, retain = TRUE) %>% 
  juice(all_outcomes(),all_predictors())

process_select_vec = sort(colnames(select_features))


library(stringr)
names_select = str_split("cci_score
cms_disabled_ind
cms_dual_eligible_ind
cms_frailty_ind
cms_hospice_ind
cms_institutional_ind
cms_low_income_ind
cms_ma_plan_ind
cms_ma_risk_score_nbr
cms_orig_reas_entitle_cd
cms_ra_factor_type_cd
cms_race_cd
cmsd2_men_mad_ind
cons_homstat
cons_hxmboh
cons_hxmh
cons_hxmioc
cons_mobplus
cons_stlindex
cons_stlnindx
dcsi_score
est_age
hi_flag
id
lang_spoken_cd
prov_line_pmpm_cnt
rucc_category
sex_cd"
,
"\n"
)

meaningful_select_vec = unlist(names_select)

```


```{r}

select_features$hi_flag <- factor(select_features$hi_flag)
set.seed(2)
ldaProfile <- rfe(x=select_features[,3:199],y = select_features$hi_flag,
                  sizes = seq(107,197,5),
                  rfeControl = rfeControl(functions = ldaFuncs, method = "cv"))

ldaProfile
predictors(ldaProfile)
plot(ldaProfile, type = c("o", "g"))
```


```{r}

ctrl <- rfeControl(functions = rfRFE, # random forest
                      method = "repeatedcv", # repeated cv
                      repeats = 1, # number of repeats
                      number = 10,
                   returnResamp = "all") # number of folds



```
change back to rf


```{r}
library(doMC)
registerDoMC(cores = 2)

set.seed(10)
result_rfe1 <- rfe(x=select_features[,3:199],y = select_features$id, sizes = seq(100,150,50), rfeControl = ctrl)


# Print the results
result_rfe1

# Print the selected features
predictors(result_rfe1)



trellis.par.set(caretTheme())
plot(result_rfe1, type = c("g", "o"))

# Print the results visually

```
For RFE we exactly return five variables:
Select TOP 5 Variables:

```{r}

rfe_predictor = predictors(result_rfe1)

rfe_predictor

```

2. receipt imputation
 
3. RFE

